<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Controle</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-4">Controle de Produção</h1>

    <div class="mb-4">
      <label>Escolha Programa</label>
      <select id="programaSelect" class="w-full p-2 border rounded"></select>
    </div>

    <div id="area" class="hidden">
      <div class="grid grid-cols-3 gap-2 mb-4">
        <input id="padrao1" disabled class="p-2 border rounded bg-gray-100">
        <input id="qtd_matrizes" disabled class="p-2 border rounded bg-gray-100">
        <input id="horaInicio" type="time" class="p-2 border rounded">
      </div>

      <table class="w-full border mb-4">
        <thead><tr class="bg-gray-200"><th>Numeração</th><th>Matrizes</th><th>Giros Inicial</th><th>Giros Atual</th><th>Produzido (min)</th><th>Resultado (min)</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
async function carregarProgramas(){
  const res = await fetch('/api/programa');
  const data = await res.json();
  const sel = document.getElementById('programaSelect');
  sel.innerHTML = '<option value="">-- selecione --</option>';
  data.forEach(p=> {
    const o = document.createElement('option');
    o.value = p.codigo;
    o.textContent = p.codigo + ' (padrao:' + p.padrao1 + ')';
    sel.appendChild(o);
  });
}

document.getElementById('programaSelect').addEventListener('change', async (e) => {
  const codigo = e.target.value;
  if (!codigo) { document.getElementById('area').classList.add('hidden'); return; }
  const res = await fetch('/api/programa?codigo=' + encodeURIComponent(codigo));
  const p = await res.json();
  document.getElementById('area').classList.remove('hidden');
  document.getElementById('padrao1').value = p.padrao1;
  document.getElementById('qtd_matrizes').value = p.qtd_matrizes;

  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  (p.dados_matrizaria || []).forEach((m, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="border p-1">${m.numeracao}</td>
      <td class="border p-1">${m.matrizes}</td>
      <td class="border p-1">${m.giros_inicial}</td>
      <td class="border p-1"><input value="${m.giros_inicial}" class="giros_atual p-1 border w-24" data-idx="${idx}"></td>
      <td class="border p-1" id="prod-${idx}">0</td>
      <td class="border p-1" id="res-${idx}">0</td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll('.giros_atual').forEach(inp => inp.addEventListener('input', () => calcular(p)));
  document.getElementById('horaInicio').addEventListener('input', () => calcular(p));
  calcular(p);
});

function calcular(programa) {
  const padrao2 = programa.padrao1 / programa.qtd_matrizes;
  let totalMinutosProduzidos = 0;

  (programa.dados_matrizaria || []).forEach((m, idx) => {
    const girosAtual = parseFloat(document.querySelector(`.giros_atual[data-idx="${idx}"]`).value) || 0;
    const padrao3 = padrao2 * m.matrizes;
    const diferenca = m.giros_inicial - girosAtual;
    const horasProduz = (diferenca / padrao3) * 60;
    totalMinutosProduzidos += horasProduz;
    document.getElementById('prod-' + idx).textContent = Math.round(horasProduz) + ' min';
  });

  const horaInicioVal = document.getElementById('horaInicio').value;
  if (!horaInicioVal) return;
  const [hi, mi] = horaInicioVal.split(':').map(Number);
  const inicioMin = hi*60 + mi;
  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset() * 60000;
  const fort = new Date(utc - 3*60*60000);
  const agoraMin = fort.getHours()*60 + fort.getMinutes();

  const resultado = (agoraMin - inicioMin) - Math.round(totalMinutosProduzidos);
  (programa.dados_matrizaria || []).forEach((_, idx) => {
    const td = document.getElementById('res-' + idx);
    if (td) {
      td.textContent = resultado + ' min';
      td.className = 'border p-1 ' + (resultado >= 0 ? 'text-green-600' : 'text-red-600');
    }
  });
}

carregarProgramas();
</script>
</body>
</html>