import { useState } from "react";

export default function Cadastro() {
  const [programas, setProgramas] = useState([
    { nome: "", matriz: "", numero_matrizes: "", saldo_giros_inicial: "" }
  ]);

  // Atualiza o valor de uma célula
  const handleChange = (index, e) => {
    const newProgramas = [...programas];
    newProgramas[index][e.target.name] = e.target.value;
    setProgramas(newProgramas);
  };

  // Adiciona uma nova linha vazia
  const addLinha = () => {
    setProgramas([
      ...programas,
      { nome: "", matriz: "", numero_matrizes: "", saldo_giros_inicial: "" }
    ]);
  };

  // Remove uma linha pelo índice
  const removeLinha = (index) => {
    const newProgramas = programas.filter((_, i) => i !== index);
    setProgramas(newProgramas);
  };

  // Envia todos os programas para o Supabase
  const handleSubmit = async (e) => {
    e.preventDefault();

    // Valida que todas as linhas estão preenchidas
    for (const [i, programa] of programas.entries()) {
      if (!programa.nome || !programa.matriz || !programa.numero_matrizes || !programa.saldo_giros_inicial) {
        alert(`Preencha todos os campos da linha ${i + 1}`);
        return;
      }
    }

    for (const programa of programas) {
      const res = await fetch("/api/programa", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(programa)
      });

      if (!res.ok) {
        const error = await res.json();
        alert("Erro ao cadastrar: " + error.error);
        return;
      }
    }

    alert("Todos os programas foram cadastrados com sucesso!");
    setProgramas([{ nome: "", matriz: "", numero_matrizes: "", saldo_giros_inicial: "" }]);
  };

  return (
    <div style={{ padding: "20px" }}>
      <h1>Cadastro de Programas</h1>
      <form onSubmit={handleSubmit}>
        <table border="1" cellPadding="5" style={{ borderCollapse: "collapse", width: "100%" }}>
          <thead>
            <tr>
              <th>Nome</th>
              <th>Matrizaria</th>
              <th>Número de Matrizes</th>
              <th>Saldo de Giros Inicial</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {programas.map((programa, index) => (
              <tr key={index}>
                <td>
                  <input
                    type="text"
                    name="nome"
                    value={programa.nome}
                    onChange={(e) => handleChange(index, e)}
                    required
                  />
                </td>
                <td>
                  <input
                    type="number"
                    name="matriz"
                    value={programa.matriz}
                    onChange={(e) => handleChange(index, e)}
                    required
                  />
                </td>
                <td>
                  <input
                    type="number"
                    name="numero_matrizes"
                    value={programa.numero_matrizes}
                    onChange={(e) => handleChange(index, e)}
                    required
                  />
                </td>
                <td>
                  <input
                    type="number"
                    name="saldo_giros_inicial"
                    value={programa.saldo_giros_inicial}
                    onChange={(e) => handleChange(index, e)}
                    required
                  />
                </td>
                <td>
                  <button type="button" onClick={() => removeLinha(index)}>
                    Remover
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        <button type="button" onClick={addLinha} style={{ marginTop: "10px", marginRight: "10px" }}>
          Adicionar Linha
        </button>
        <button type="submit" style={{ marginTop: "10px" }}>
          Cadastrar Programas
        </button>
      </form>
    </div>
  );
}
