<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro de Programas</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
  h1 { font-size: 2em; margin-bottom: 20px; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  input[type="text"], input[type="number"] { width: 100%; padding: 5px; }
  button { padding: 8px 12px; margin: 5px; cursor: pointer; }
  .btn-add { background-color: #28a745; color: white; border: none; border-radius: 5px; }
  .btn-remove { background-color: #dc3545; color: white; border: none; border-radius: 5px; }
</style>
</head>
<body>

<h1>Cadastro de Programas</h1>

<form id="formProgramas">
  <div id="programas-container">
    <div class="programa">
      <label>Nome do Programa: <input type="text" name="nome" required></label>
      <label>Padrão1: <input type="number" name="padrao1" required min="1"></label>

      <table>
        <thead>
          <tr>
            <th>Numeração</th>
            <th>Número de Matrizes</th>
            <th>Saldo de Giros Inicial</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="number" name="numero" required min="0"></td>
            <td><input type="number" name="numero_matrizes" required min="1"></td>
            <td><input type="number" name="saldo_giros_inicial" required min="0"></td>
            <td><button type="button" class="btn-remove" onclick="removerLinha(this)">Remover</button></td>
          </tr>
        </tbody>
      </table>
      <button type="button" class="btn-add" onclick="adicionarLinha(this)">Adicionar Numeração</button>
      <hr>
    </div>
  </div>

  <button type="button" class="btn-add" onclick="adicionarPrograma()">Adicionar Programa</button>
  <button type="submit" class="btn-add">Cadastrar Todos</button>
</form>

<script>
function adicionarLinha(btn) {
  const tabela = btn.previousElementSibling;
  const tbody = tabela.querySelector('tbody');
  const novaLinha = tbody.rows[0].cloneNode(true);
  novaLinha.querySelectorAll('input').forEach(input => input.value = '');
  tbody.appendChild(novaLinha);
}

function removerLinha(btn) {
  const tbody = btn.closest('tbody');
  if(tbody.rows.length > 1) btn.closest('tr').remove();
}

function adicionarPrograma() {
  const container = document.getElementById('programas-container');
  const primeiro = container.querySelector('.programa');
  const novo = primeiro.cloneNode(true);
  novo.querySelectorAll('input').forEach(input => input.value = '');
  container.appendChild(novo);
}

// Função de validação simples
function validarPrograma(nome, padrao1, numeros) {
  if(!nome || nome.trim() === '') return "Nome do programa é obrigatório.";
  if(!padrao1 || padrao1 <= 0) return "Padrão1 deve ser maior que zero.";
  if(!numeros || numeros.length === 0) return "Adicione pelo menos uma numeração.";
  for(const n of numeros) {
    if(n.numero < 0) return "Numeração deve ser >= 0";
    if(n.numero_matrizes <= 0) return "Número de matrizes deve ser > 0";
    if(n.saldo_giros_inicial < 0) return "Saldo de giros inicial deve ser >= 0";
  }
  return null;
}

document.getElementById('formProgramas').addEventListener('submit', async function(e) {
  e.preventDefault();

  const programasContainer = document.getElementById('programas-container');
  const programasDivs = programasContainer.querySelectorAll('.programa');

  for (const progDiv of programasDivs) {
    const nome = progDiv.querySelector('input[name="nome"]').value;
    const padrao1 = parseFloat(progDiv.querySelector('input[name="padrao1"]').value);

    const numeros = [];
    const rows = progDiv.querySelectorAll('tbody tr');
    rows.forEach(row => {
      const numero = parseInt(row.querySelector('input[name="numero"]').value);
      const numero_matrizes = parseInt(row.querySelector('input[name="numero_matrizes"]').value);
      const saldo_giros_inicial = parseFloat(row.querySelector('input[name="saldo_giros_inicial"]').value);
      numeros.push({ numero, numero_matrizes, saldo_giros_inicial });
    });

    const erro = validarPrograma(nome, padrao1, numeros);
    if(erro) {
      alert("Erro no programa '" + nome + "': " + erro);
      return;
    }

    // Debug: mostrar JSON antes de enviar
    console.log("Enviando para API:", JSON.stringify({ nome, padrao1, numeros }, null, 2));

    // Envia para a API
    try {
      const res = await fetch('/api/programa', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome, padrao1, numeros })
      });

      const data = await res.json();
      if(!res.ok) throw new Error(data.error || 'Erro desconhecido na API');

    } catch (err) {
      alert('Erro ao cadastrar programa: ' + err.message);
      console.error(err);
      return;
    }
  }

  alert('Todos os programas cadastrados com sucesso!');
  // Limpa formulário
  programasContainer.innerHTML = '';
  adicionarPrograma();
});
</script>

</body>
</html>
